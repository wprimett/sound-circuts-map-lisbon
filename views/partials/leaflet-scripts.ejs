<!-- <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

<script src="js/L.Mask.js"></script>

<script src="/js/leaflet.ajax.min.js"></script>

<!-- <script src="/data/sound_circuts_programme.js"></script> -->

<script>

  Polygons = []
  Points = []

  // for (i = 0; i < sc_json.features.length; i++){
  //   feature_json = sc_json["features"][i];
  //   feature_type = feature_json["geometry"]["type"];
  //   if (feature_type === "Polygon"){
  //     Polygons.push(feature_json)
  //   }else if (feature_type === "Point"){
  //     Points.push(feature_json)
  //   }
  // }

  // for (i = 0; i < Polygons.length; i++){
  //   ply_json = Polygons[i];
  //   console.log(ply_json.geometry.coordinates)
  //
  //   ply_obj = L.geoJSON(ply_json);
  //   for (j = 0; j < Points.length; j++){
  //     pnt_json = Points[j];
  //     console.log(pnt_json.geometry.coordinates)
  //     pnt_obj = L.geoJSON(pnt_json)
  //
  //     if (inside(pnt_json.geometry.coordinates,ply_json.geometry.coordinates)){
  //       console.log("asdas")
  //     }
  //   }
  // }

// var map_url = 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png'
  var map_url_global = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png'
  var map_url_install = 'https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png'
  var cartodbAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attribution">CARTO</a>';

  function generate_map(lat,lng,zoom){
    var map = L.map('map', {
      'center': [lat,lng],
      'zoom': zoom,
      'layers': [
      L.tileLayer(map_url_install, {
        attribution: cartodbAttribution
      })
      ]
    });
    // or, add to an existing map:
    map.addControl(new L.Control.Fullscreen());
    return map;
  }

  map = generate_map(lat,lng,zoom);

  var yellowPinIcon = new L.Icon({
    iconUrl: 'img/marker-icon-2x-gold-75.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  function userUpdateLocation(user_lat, user_lng){
    console.log("updated");
    zoom = 14;
    map.remove();
    map = generate_map(user_lat, user_lng, zoom);
    L.marker([user_lat, user_lng], {icon: yellowPinIcon}).addTo(map)
    .bindPopup("You are here").openPopup();
    ;
  }

  // function onLocationFound(e) {
  //   var radius = e.accuracy / 2;
  //
  //   L.marker(e.latlng).addTo(map)
  //     .bindPopup("You are within " + radius + " meters from this point").openPopup();
  //
  //   L.circle(e.latlng, radius).addTo(map);
  // }
  //
  // function onLocationError(e) {
  //   alert(e.message);
  // }
  //
  // map.on('locationfound', onLocationFound);
  // map.on('locationerror', onLocationError);
  //
  // map.locate({setView: true, maxZoom: 16});

  // mask.ejs
  var latLngs = [];
  var layerpoly = [];
  var mask_coordinates = [];
  // var coordinates;
  var active_area_id = 0;

  for (i=0; i<location_bounds.length; i++) {
    var coordinates = location_bounds[i].features[0].geometry.coordinates[0];
    mask_coordinates.push(coordinates);

    latLngs.push(new L.LatLng(coordinates[i][1], coordinates[i][0]));
  }

  var mask = L.mask(latLngs)
  mask.addTo(map);

  var options = {
    style: function (feature) {
      return {
        "color": "yellow",
        "weight": 2,
        "opacity": 0.4,
        "fillColor": "transparent",
        "fillOpacity": 0.
      };
    }
  };
  console.log(coordinates)

  function updateMask(){

    for (i=0; i<location_bounds.length; i++) {
        var lpoly = new L.geoJson(location_bounds[i].features, options)
        layerpoly.push(lpoly);
        lpoly.addTo(map);
      }
    layerpoly[0].on('mouseover', function(e) {
      //open popup;
      active_area = 0;
      var popup = L.popup()
      .setLatLng(e.latlng)
      .setContent('Sound Circut')
      .openOn(map);
      map.removeLayer(mask)
      latLngs = []
      for (i=0; i<mask_coordinates[0].length; i++) {
        var coordinates = mask_coordinates[0];
        latLngs.push(new L.LatLng(coordinates[i][1], coordinates[i][0]));
      }
      // map.remove();
      // map = generate_map(lat, lng, zoom);
      mask = L.mask(latLngs)
      mask.addTo(map);
      updateMask();
    });
  }

  updateMask();
</script>
